name: Semver Action Test

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (semver)'
        required: true

jobs:
  test:
    name: Release
    runs-on: ubuntu-latest
    env:
      RELEASE_NOTES_FILENAME: release_notes
    outputs:
      create_pr: ${{ env.CREATE_PR }}
      next_version_snapshot: ${{ env.NEXT_VERSION_SNAPSHOT }}
      pr_title: ${{ env.PR_TITLE }}
      release_branch: ${{ env.RELEASE_BRANCH }}

    steps:
      - name: Parse Version Old
        id: version_parser
        uses: terradatum/semver-action@v1
        with:
          bump: preminor
          version: ${{ github.event.inputs.version }}

      - uses: madhead/semver-utils@latest
        id: version_parser_new
        with:
          lenient: false
          version: ${{ github.event.inputs.version }}

      - run: |
          NEXT_VERSION_SNAPSHOT=${{ format('{0}.{1}.0-SNAPSHOT', steps.version_parser.outputs.major, steps.version_parser.outputs.next-minor) }}
          echo "old next version snapshot - ${NEXT_VERSION_SNAPSHOT}"
          echo "old major - ${{ steps.version_parser.outputs.major }}, old minor - ${{ steps.version_parser.outputs.minor }}"
          echo "old version - ${{ steps.version_parser.outputs.version }}"
          echo "old prerelease - ${{ steps.version_parser.outputs.pre-release }}"

          PREMINOR_VERSION=${{ steps.version_parser_new.outputs.inc-preminor }}
          NEXT_VERSION_SNAPSHOT=${PREMINOR_VERSION//-0/-SNAPSHOT}
          RELEASE_BRANCH="release/${{ steps.version_parser.outputs.major }}.${{ steps.version_parser.outputs.minor }}"
          [[ -z "${{ steps.version_parser_new.outputs.prerelease }}" ]] && \
            VERSION=${{ steps.version_parser_new.outputs.release }} || \
            VERSION="${{ steps.version_parser_new.outputs.release }}-${{ steps.version_parser_new.outputs.prerelease }}"
          RELEASE_TAG="v${VERSION}"

          cat >> $GITHUB_ENV <<EOF
          NEXT_VERSION_SNAPSHOT=$NEXT_VERSION_SNAPSHOT
          RELEASE_BRANCH=$RELEASE_BRANCH
          RELEASE_TAG=$RELEASE_TAG
          VERSION=$VERSION
          EOF

      - run: |
          echo "NEXT_VERSION_SNAPSHOT - $NEXT_VERSION_SNAPSHOT"
          echo "RELEASE_BRANCH - $RELEASE_BRANCH"
          echo "RELEASE_TAG - $RELEASE_TAG"
          echo "VERSION - $VERSION"
